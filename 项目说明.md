# DeepSeek GraphQL Workers 项目

## 🎯 项目简介

这是一个基于 **Cloudflare Workers** 的 GraphQL API 项目，用于为前端 AI 聊天机器人提供与 **DeepSeek AI** 的交互接口。项目使用 TypeScript 开发，结构简单清晰，适合学习 GraphQL 和 Workers 开发。

## 🏗️ 项目架构

```
c1-ds-graphql-workers/
├── src/
│   ├── index.ts        # Workers 主入口文件
│   ├── schema.ts       # GraphQL Schema 定义
│   ├── resolvers.ts    # GraphQL Resolvers 实现
│   └── deepseek.ts     # DeepSeek API 集成
├── package.json        # 项目配置和依赖
├── wrangler.toml       # Cloudflare Workers 配置
├── tsconfig.json       # TypeScript 配置
├── .env.example        # 环境变量示例
└── 项目说明.md         # 本说明文档
```

## 🚀 核心功能

### 1. GraphQL API 接口
- **健康检查**: 检查服务状态
- **模型列表**: 获取支持的 AI 模型
- **聊天接口**: 发送消息获取 AI 回复

### 2. DeepSeek AI 集成
- 支持 `deepseek-chat` 和 `deepseek-coder` 模型
- 可配置温度参数（0-1）控制回复随机性
- 可设置最大 token 数量控制回复长度
- 支持系统提示词自定义 AI 角色

### 3. 跨域支持
- 完整的 CORS 配置
- 支持 OPTIONS 预检请求
- 允许前端跨域调用

## 📋 环境要求

- **Node.js** 18+ 
- **npm** 或 **yarn**
- **Cloudflare 账号**（用于部署）
- **DeepSeek API 密钥**

## 🔧 安装配置

### 1. 安装依赖

```bash
# 克隆项目后，安装依赖
npm install

# 或使用 yarn
yarn install
```

### 2. 环境变量配置

复制 `.env.example` 文件并重命名为 `.env`：

```bash
cp .env.example .env
```

编辑 `.env` 文件，设置你的 DeepSeek API 密钥：

```env
# DeepSeek API 配置
DEEPSEEK_API_KEY=你的API密钥
DEEPSEEK_API_URL=https://api.deepseek.com/v1
```

> **重要提示**: 实际部署时，敏感信息应在 Cloudflare Dashboard 中设置为 Secrets，不要将 API 密钥提交到代码仓库。

### 3. 本地开发

```bash
# 启动开发服务器
npm run dev

# 或
yarn dev
```

开发服务器启动后，访问 `http://localhost:8787` 即可看到 GraphQL Playground。

## 🎮 API 使用方法

### 1. 健康检查

```graphql
query {
  health
}
```

**响应示例：**
```json
{
  "data": {
    "health": "GraphQL DeepSeek API 服务运行正常！"
  }
}
```

### 2. 获取模型列表

```graphql
query {
  models
}
```

**响应示例：**
```json
{
  "data": {
    "models": ["deepseek-chat", "deepseek-coder"]
  }
}
```

### 3. 发送聊天消息

```graphql
mutation {
  chat(input: {
    message: "你好，请介绍一下自己"
    model: "deepseek-chat"
    temperature: 0.7
    maxTokens: 1000
    systemPrompt: "你是一个友好的AI助手"
  }) {
    id
    message
    model
    usage {
      promptTokens
      completionTokens
      totalTokens
    }
    conversationId
    timestamp
    finishReason
  }
}
```

**响应示例：**
```json
{
  "data": {
    "chat": {
      "id": "cmpl-123456",
      "message": "你好！我是DeepSeek，一个由深度求索开发的AI助手...",
      "model": "deepseek-chat",
      "usage": {
        "promptTokens": 20,
        "completionTokens": 50,
        "totalTokens": 70
      },
      "conversationId": "conv-123456",
      "timestamp": "2024-01-15T10:30:00.000Z",
      "finishReason": "stop"
    }
  }
}
```

## 🌐 前端集成示例

### JavaScript/TypeScript

```javascript
// GraphQL 请求函数
async function sendChatMessage(message) {
  const query = `
    mutation SendMessage($message: String!) {
      chat(input: { 
        message: $message 
        temperature: 0.7
        maxTokens: 2000
      }) {
        id
        message
        usage {
          totalTokens
        }
        timestamp
      }
    }
  `;

  const response = await fetch('https://你的workers域名.workers.dev/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      query,
      variables: { message }
    })
  });

  const result = await response.json();
  return result.data.chat;
}

// 使用示例
sendChatMessage('你好，今天天气怎么样？')
  .then(response => {
    console.log('AI回复:', response.message);
    console.log('使用tokens:', response.usage.totalTokens);
  })
  .catch(error => {
    console.error('发送消息失败:', error);
  });
```

### React 组件示例

```jsx
import React, { useState } from 'react';

function ChatBot() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);

  const sendMessage = async () => {
    if (!input.trim()) return;

    setLoading(true);
    const userMessage = { role: 'user', content: input, timestamp: new Date() };
    setMessages(prev => [...prev, userMessage]);

    try {
      const query = `
        mutation {
          chat(input: { message: "${input}" }) {
            message
            timestamp
          }
        }
      `;

      const response = await fetch('https://你的workers域名.workers.dev/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });

      const result = await response.json();
      const aiMessage = {
        role: 'assistant',
        content: result.data.chat.message,
        timestamp: new Date(result.data.chat.timestamp)
      };

      setMessages(prev => [...prev, aiMessage]);
    } catch (error) {
      console.error('发送消息失败:', error);
    } finally {
      setLoading(false);
      setInput('');
    }
  };

  return (
    <div className="chat-container">
      <div className="messages">
        {messages.map((msg, index) => (
          <div key={index} className={`message ${msg.role}`}>
            <strong>{msg.role === 'user' ? '你' : 'AI'}:</strong>
            <span>{msg.content}</span>
          </div>
        ))}
      </div>
      
      <div className="input-area">
        <input
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
          placeholder="输入消息..."
          disabled={loading}
        />
        <button onClick={sendMessage} disabled={loading || !input.trim()}>
          {loading ? '发送中...' : '发送'}
        </button>
      </div>
    </div>
  );
}

export default ChatBot;
```

## 🚀 部署到 Cloudflare Workers

### 1. 登录 Cloudflare

```bash
# 首次使用需要登录
npx wrangler login
```

### 2. 设置环境变量

在 Cloudflare Dashboard 中设置 Secrets：

```bash
# 设置 DeepSeek API 密钥
npx wrangler secret put DEEPSEEK_API_KEY
# 输入你的 API 密钥

# 可选：设置自定义 API 地址
npx wrangler secret put DEEPSEEK_API_URL
# 输入: https://api.deepseek.com/v1
```

### 3. 部署项目

```bash
# 部署到生产环境
npm run deploy

# 或
npx wrangler publish
```

部署成功后，你会得到一个类似 `https://deepseek-graphql-workers.你的账号.workers.dev` 的 URL。

## 🔍 错误处理

项目包含完善的错误处理机制：

### 1. API 密钥错误
- **错误码**: 401
- **提示**: "DeepSeek API 密钥无效，请检查配置"

### 2. 请求频率限制
- **错误码**: 429  
- **提示**: "请求频率过高，请稍后重试"

### 3. 服务不可用
- **错误码**: 500
- **提示**: "DeepSeek 服务暂时不可用，请稍后重试"

### 4. 参数验证
- 自动验证温度参数范围（0-1）
- 自动限制 token 数量（1-4000）
- 检查消息内容不为空

## 📊 性能监控

### 查看日志

```bash
# 查看实时日志
npx wrangler tail

# 查看特定时间段的日志
npx wrangler tail --since 2024-01-15T10:00:00Z
```

### 监控指标

在 Cloudflare Dashboard 中可以查看：
- 请求数量和频率
- 响应时间
- 错误率
- CPU 使用率

## 🛠️ 开发技巧

### 1. GraphQL Schema 设计
- 使用有意义的类型名称
- 添加详细的注释说明
- 合理设计输入参数的默认值

### 2. 错误处理最佳实践
- 区分不同类型的错误
- 提供用户友好的错误消息
- 记录详细的错误日志便于调试

### 3. API 调用优化
- 实现参数验证避免无效请求
- 合理设置超时时间
- 考虑实现缓存机制

### 4. 安全考虑
- 永远不要在代码中硬编码 API 密钥
- 使用 Cloudflare Secrets 管理敏感信息
- 实现适当的速率限制

## 🎯 扩展建议

### 1. 功能扩展
- **对话历史**: 实现会话状态管理
- **用户认证**: 添加用户身份验证
- **消息缓存**: 使用 Workers KV 缓存历史消息
- **流式响应**: 支持实时流式聊天

### 2. 技术优化
- **类型安全**: 完善 TypeScript 类型定义
- **单元测试**: 添加测试用例
- **性能监控**: 集成 APM 工具
- **文档生成**: 自动生成 GraphQL 文档

### 3. 多模型支持
- 集成更多 AI 模型提供商
- 实现模型选择和切换
- 支持不同模型的特定参数

## ❓ 常见问题

### Q1: 如何获取 DeepSeek API 密钥？
A: 访问 [DeepSeek 官网](https://platform.deepseek.com) 注册账号并申请 API 密钥。

### Q2: 为什么本地开发时出现 CORS 错误？
A: 确保你的前端应用使用的是正确的 GraphQL 端点，并且 Workers 已正确配置 CORS 头部。

### Q3: 如何处理大量并发请求？
A: Cloudflare Workers 天然支持高并发，但需要注意 DeepSeek API 的速率限制。

### Q4: 可以部署到其他平台吗？
A: 代码主要依赖标准的 Web API，理论上可以适配到其他支持 JavaScript 的 serverless 平台。

### Q5: 如何实现消息历史记录？
A: 可以使用 Cloudflare Workers KV 存储对话历史，或集成外部数据库。

## 📞 技术支持

如果在使用过程中遇到问题：

1. 检查 Cloudflare Workers 的日志输出
2. 验证 API 密钥是否正确配置
3. 确认网络连接和防火墙设置
4. 查看 DeepSeek API 的状态页面

---

**🎉 恭喜！** 你现在已经拥有了一个完整的 GraphQL + DeepSeek AI 聊天后端服务。这个项目可以作为学习 GraphQL、Cloudflare Workers 和 AI API 集成的良好起点。

记住，实际生产环境中还需要考虑更多的安全性、性能和可维护性方面的优化。继续学习和改进吧！ 🚀