# GraphQL API æµ‹è¯•ç¤ºä¾‹

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

è®¿é—® `http://localhost:8787` è¿›å…¥ GraphQL Playgroundã€‚

### 2. å¥åº·æ£€æŸ¥æµ‹è¯•

```graphql
query HealthCheck {
  health
}
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "data": {
    "health": "GraphQL DeepSeek API æœåŠ¡è¿è¡Œæ­£å¸¸ï¼"
  }
}
```

### 3. è·å–æ”¯æŒçš„æ¨¡å‹

```graphql
query GetModels {
  models
}
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "data": {
    "models": ["deepseek-chat", "deepseek-coder"]
  }
}
```

### 4. ç®€å•èŠå¤©æµ‹è¯•

```graphql
mutation SimpleChat {
  chat(input: {
    message: "ä½ å¥½"
  }) {
    id
    message
    model
    timestamp
  }
}
```

### 5. å®Œæ•´å‚æ•°èŠå¤©æµ‹è¯•

```graphql
mutation FullChat {
  chat(input: {
    message: "è¯·ç”¨ç®€æ´çš„è¯­è¨€ä»‹ç»ä¸€ä¸‹ GraphQL çš„ä¼˜åŠ¿"
    model: "deepseek-chat"
    temperature: 0.7
    maxTokens: 500
    systemPrompt: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯ä¸“å®¶ï¼Œæ“…é•¿è§£é‡Šå¤æ‚æ¦‚å¿µ"
  }) {
    id
    message
    model
    usage {
      promptTokens
      completionTokens
      totalTokens
    }
    conversationId
    timestamp
    finishReason
  }
}
```

### 6. ç¼–ç¨‹é—®é¢˜æµ‹è¯•

```graphql
mutation CodingQuestion {
  chat(input: {
    message: "ç”¨ Python å†™ä¸€ä¸ªè®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„å‡½æ•°"
    model: "deepseek-coder"
    temperature: 0.3
    maxTokens: 800
  }) {
    message
    usage {
      totalTokens
    }
  }
}
```

## ğŸ”§ ä½¿ç”¨ curl æµ‹è¯•

### å¥åº·æ£€æŸ¥

```bash
curl -X POST http://localhost:8787/ \
  -H "Content-Type: application/json" \
  -d '{
    "query": "query { health }"
  }'
```

### èŠå¤©æµ‹è¯•

```bash
curl -X POST http://localhost:8787/ \
  -H "Content-Type: application/json" \
  -d '{
    "query": "mutation { chat(input: { message: \"ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ\" }) { message timestamp } }"
  }'
```

## ğŸ› å¸¸è§é”™è¯¯å¤„ç†æµ‹è¯•

### 1. ç©ºæ¶ˆæ¯æµ‹è¯•

```graphql
mutation EmptyMessage {
  chat(input: {
    message: ""
  }) {
    message
  }
}
```

**é¢„æœŸå“åº”ï¼š** é”™è¯¯æç¤º "æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º"

### 2. æ— æ•ˆæ¸©åº¦å‚æ•°æµ‹è¯•

```graphql
mutation InvalidTemperature {
  chat(input: {
    message: "æµ‹è¯•"
    temperature: 2.0
  }) {
    message
  }
}
```

**è¯´æ˜ï¼š** ç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ¸©åº¦å€¼é™åˆ¶åœ¨ 0-1 èŒƒå›´å†…

### 3. è¶…å¤§ token æ•°æµ‹è¯•

```graphql
mutation LargeTokens {
  chat(input: {
    message: "æµ‹è¯•"
    maxTokens: 10000
  }) {
    message
    usage {
      completionTokens
    }
  }
}
```

**è¯´æ˜ï¼š** ç³»ç»Ÿä¼šè‡ªåŠ¨å°† maxTokens é™åˆ¶åœ¨ 1-4000 èŒƒå›´å†…

## ğŸ“Š æ€§èƒ½æµ‹è¯•å»ºè®®

### 1. å¹¶å‘è¯·æ±‚æµ‹è¯•

å¯ä»¥ä½¿ç”¨ Apache Bench (ab) è¿›è¡Œç®€å•çš„å¹¶å‘æµ‹è¯•ï¼š

```bash
# å®‰è£… abï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
# macOS: brew install httpd
# Ubuntu: sudo apt-get install apache2-utils

# å¹¶å‘æµ‹è¯•ï¼ˆ10ä¸ªå¹¶å‘ï¼Œæ€»å…±100ä¸ªè¯·æ±‚ï¼‰
ab -n 100 -c 10 -p test-payload.json -T application/json http://localhost:8787/
```

å…¶ä¸­ `test-payload.json` å†…å®¹ï¼š
```json
{
  "query": "mutation { chat(input: { message: \"ç®€å•æµ‹è¯•\" }) { message } }"
}
```

### 2. å“åº”æ—¶é—´ç›‘æ§

åœ¨ GraphQL Playground ä¸­æŸ¥çœ‹æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ï¼Œå…³æ³¨ï¼š
- ç®€å•æŸ¥è¯¢ï¼ˆhealthï¼‰: åº”è¯¥åœ¨ 10ms ä»¥å†…
- èŠå¤©è¯·æ±‚: å–å†³äº DeepSeek API å“åº”æ—¶é—´ï¼Œé€šå¸¸ 1-5 ç§’

## ğŸ¯ å‰ç«¯é›†æˆæµ‹è¯•

### JavaScript ç¤ºä¾‹

```javascript
// æµ‹è¯•å¥åº·æ£€æŸ¥
async function testHealth() {
  const response = await fetch('http://localhost:8787/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: 'query { health }'
    })
  });
  
  const data = await response.json();
  console.log('å¥åº·æ£€æŸ¥:', data);
}

// æµ‹è¯•èŠå¤©åŠŸèƒ½
async function testChat(message) {
  const response = await fetch('http://localhost:8787/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: `
        mutation {
          chat(input: { message: "${message}" }) {
            message
            usage { totalTokens }
            timestamp
          }
        }
      `
    })
  });
  
  const data = await response.json();
  console.log('èŠå¤©å“åº”:', data);
  return data;
}

// è¿è¡Œæµ‹è¯•
testHealth();
testChat('ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±');
```

### React Hook ç¤ºä¾‹

```jsx
import { useState, useCallback } from 'react';

export function useGraphQLChat(endpoint = 'http://localhost:8787/') {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const sendMessage = useCallback(async (message, options = {}) => {
    setLoading(true);
    setError(null);

    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query: `
            mutation SendMessage($message: String!, $model: String, $temperature: Float, $maxTokens: Int) {
              chat(input: {
                message: $message
                model: $model
                temperature: $temperature
                maxTokens: $maxTokens
              }) {
                id
                message
                model
                usage { promptTokens completionTokens totalTokens }
                timestamp
                finishReason
              }
            }
          `,
          variables: {
            message,
            model: options.model || 'deepseek-chat',
            temperature: options.temperature || 0.7,
            maxTokens: options.maxTokens || 2000
          }
        })
      });

      const data = await response.json();
      
      if (data.errors) {
        throw new Error(data.errors[0].message);
      }

      return data.data.chat;
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  }, [endpoint]);

  return { sendMessage, loading, error };
}
```

## ğŸ“ éƒ¨ç½²å‰æµ‹è¯•æ¸…å•

åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] âœ… å¥åº·æ£€æŸ¥ API æ­£å¸¸è¿”å›
- [ ] âœ… æ¨¡å‹åˆ—è¡¨ API æ­£å¸¸è¿”å›  
- [ ] âœ… èŠå¤© API èƒ½æ­£ç¡®å¤„ç†å„ç§å‚æ•°
- [ ] âœ… é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] âœ… CORS å¤´éƒ¨é…ç½®æ­£ç¡®
- [ ] âœ… API å¯†é’¥ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] âœ… TypeScript ç¼–è¯‘æ— é”™è¯¯
- [ ] âœ… åŸºæœ¬çš„æ€§èƒ½æµ‹è¯•é€šè¿‡

## ğŸ‰ ç¥è´ºï¼

å¦‚æœä»¥ä¸Šæµ‹è¯•éƒ½é€šè¿‡äº†ï¼Œè¯´æ˜ä½ çš„ GraphQL + DeepSeek API åç«¯æœåŠ¡å·²ç»å‡†å¤‡å°±ç»ªï¼

ä¸‹ä¸€æ­¥å¯ä»¥ï¼š
1. éƒ¨ç½²åˆ° Cloudflare Workers ç”Ÿäº§ç¯å¢ƒ
2. é›†æˆåˆ°ä½ çš„å‰ç«¯åº”ç”¨ä¸­
3. æ·»åŠ æ›´å¤šé«˜çº§åŠŸèƒ½ï¼ˆå¦‚å¯¹è¯å†å²ã€ç”¨æˆ·è®¤è¯ç­‰ï¼‰

Happy coding! ğŸš€