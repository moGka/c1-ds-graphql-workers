# GraphQL API 测试示例

## 🚀 快速测试

### 1. 启动开发服务器

```bash
npm run dev
```

访问 `http://localhost:8787` 进入 GraphQL Playground。

### 2. 健康检查测试

```graphql
query HealthCheck {
  health
}
```

**预期响应：**
```json
{
  "data": {
    "health": "GraphQL DeepSeek API 服务运行正常！"
  }
}
```

### 3. 获取支持的模型

```graphql
query GetModels {
  models
}
```

**预期响应：**
```json
{
  "data": {
    "models": ["deepseek-chat", "deepseek-coder"]
  }
}
```

### 4. 简单聊天测试

```graphql
mutation SimpleChat {
  chat(input: {
    message: "你好"
  }) {
    id
    message
    model
    timestamp
  }
}
```

### 5. 完整参数聊天测试

```graphql
mutation FullChat {
  chat(input: {
    message: "请用简洁的语言介绍一下 GraphQL 的优势"
    model: "deepseek-chat"
    temperature: 0.7
    maxTokens: 500
    systemPrompt: "你是一个专业的技术专家，擅长解释复杂概念"
  }) {
    id
    message
    model
    usage {
      promptTokens
      completionTokens
      totalTokens
    }
    conversationId
    timestamp
    finishReason
  }
}
```

### 6. 编程问题测试

```graphql
mutation CodingQuestion {
  chat(input: {
    message: "用 Python 写一个计算斐波那契数列的函数"
    model: "deepseek-coder"
    temperature: 0.3
    maxTokens: 800
  }) {
    message
    usage {
      totalTokens
    }
  }
}
```

## 🔧 使用 curl 测试

### 健康检查

```bash
curl -X POST http://localhost:8787/ \
  -H "Content-Type: application/json" \
  -d '{
    "query": "query { health }"
  }'
```

### 聊天测试

```bash
curl -X POST http://localhost:8787/ \
  -H "Content-Type: application/json" \
  -d '{
    "query": "mutation { chat(input: { message: \"你好，今天天气如何？\" }) { message timestamp } }"
  }'
```

## 🐛 常见错误处理测试

### 1. 空消息测试

```graphql
mutation EmptyMessage {
  chat(input: {
    message: ""
  }) {
    message
  }
}
```

**预期响应：** 错误提示 "消息内容不能为空"

### 2. 无效温度参数测试

```graphql
mutation InvalidTemperature {
  chat(input: {
    message: "测试"
    temperature: 2.0
  }) {
    message
  }
}
```

**说明：** 系统会自动将温度值限制在 0-1 范围内

### 3. 超大 token 数测试

```graphql
mutation LargeTokens {
  chat(input: {
    message: "测试"
    maxTokens: 10000
  }) {
    message
    usage {
      completionTokens
    }
  }
}
```

**说明：** 系统会自动将 maxTokens 限制在 1-4000 范围内

## 📊 性能测试建议

### 1. 并发请求测试

可以使用 Apache Bench (ab) 进行简单的并发测试：

```bash
# 安装 ab（如果还没有的话）
# macOS: brew install httpd
# Ubuntu: sudo apt-get install apache2-utils

# 并发测试（10个并发，总共100个请求）
ab -n 100 -c 10 -p test-payload.json -T application/json http://localhost:8787/
```

其中 `test-payload.json` 内容：
```json
{
  "query": "mutation { chat(input: { message: \"简单测试\" }) { message } }"
}
```

### 2. 响应时间监控

在 GraphQL Playground 中查看每个请求的响应时间，关注：
- 简单查询（health）: 应该在 10ms 以内
- 聊天请求: 取决于 DeepSeek API 响应时间，通常 1-5 秒

## 🎯 前端集成测试

### JavaScript 示例

```javascript
// 测试健康检查
async function testHealth() {
  const response = await fetch('http://localhost:8787/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: 'query { health }'
    })
  });
  
  const data = await response.json();
  console.log('健康检查:', data);
}

// 测试聊天功能
async function testChat(message) {
  const response = await fetch('http://localhost:8787/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: `
        mutation {
          chat(input: { message: "${message}" }) {
            message
            usage { totalTokens }
            timestamp
          }
        }
      `
    })
  });
  
  const data = await response.json();
  console.log('聊天响应:', data);
  return data;
}

// 运行测试
testHealth();
testChat('你好，请介绍一下自己');
```

### React Hook 示例

```jsx
import { useState, useCallback } from 'react';

export function useGraphQLChat(endpoint = 'http://localhost:8787/') {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const sendMessage = useCallback(async (message, options = {}) => {
    setLoading(true);
    setError(null);

    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query: `
            mutation SendMessage($message: String!, $model: String, $temperature: Float, $maxTokens: Int) {
              chat(input: {
                message: $message
                model: $model
                temperature: $temperature
                maxTokens: $maxTokens
              }) {
                id
                message
                model
                usage { promptTokens completionTokens totalTokens }
                timestamp
                finishReason
              }
            }
          `,
          variables: {
            message,
            model: options.model || 'deepseek-chat',
            temperature: options.temperature || 0.7,
            maxTokens: options.maxTokens || 2000
          }
        })
      });

      const data = await response.json();
      
      if (data.errors) {
        throw new Error(data.errors[0].message);
      }

      return data.data.chat;
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  }, [endpoint]);

  return { sendMessage, loading, error };
}
```

## 📝 部署前测试清单

在部署到生产环境之前，请确保：

- [ ] ✅ 健康检查 API 正常返回
- [ ] ✅ 模型列表 API 正常返回  
- [ ] ✅ 聊天 API 能正确处理各种参数
- [ ] ✅ 错误处理机制正常工作
- [ ] ✅ CORS 头部配置正确
- [ ] ✅ API 密钥环境变量配置正确
- [ ] ✅ TypeScript 编译无错误
- [ ] ✅ 基本的性能测试通过

## 🎉 祝贺！

如果以上测试都通过了，说明你的 GraphQL + DeepSeek API 后端服务已经准备就绪！

下一步可以：
1. 部署到 Cloudflare Workers 生产环境
2. 集成到你的前端应用中
3. 添加更多高级功能（如对话历史、用户认证等）

Happy coding! 🚀